{% extends 'dashboard/base.html' %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-person-badge me-2"></i>Detalle del Paciente</h2>
        <a href="{% url 'doctor_patient_list' %}" class="btn btn-secondary">
            <i class="bi bi-arrow-left me-1"></i>Volver a Lista
        </a>
    </div>

    {% if not ficha %}
    <div class="alert alert-warning" role="alert">
        <i class="bi bi-exclamation-triangle me-2"></i>
        <strong>Atención:</strong> Este paciente no tiene ficha médica registrada.
    </div>
    {% endif %}

    <!-- Información General del Paciente -->
    <div class="card mb-3">
        <div class="card-header bg-primary text-white">
            <i class="bi bi-person-vcard me-2"></i>Información General
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <p class="mb-2"><strong><i class="bi bi-person me-2"></i>Nombre Completo:</strong></p>
                    <p class="ms-4 mb-3">{{ paciente.nombre }} {{ paciente.apellido1 }} {{ paciente.apellido2 }}</p>

                    <p class="mb-2"><strong><i class="bi bi-card-text me-2"></i>RUT:</strong></p>
                    <p class="ms-4 mb-3">{{ paciente.rut }}</p>

                    <p class="mb-2"><strong><i class="bi bi-calendar-event me-2"></i>Fecha de Nacimiento:</strong></p>
                    <p class="ms-4 mb-3">{{ paciente.fecha_nacimiento|date:"d/m/Y" }}</p>
                </div>

                <div class="col-md-6">
                    <p class="mb-2"><strong><i class="bi bi-telephone me-2"></i>Teléfono:</strong></p>
                    <p class="ms-4 mb-3">{{ paciente.telefono }}</p>

                    <p class="mb-2"><strong><i class="bi bi-geo-alt me-2"></i>Dirección:</strong></p>
                    <p class="ms-4 mb-3">{{ paciente.direccion }}</p>

                    {% if ficha %}
                    <p class="mb-2"><strong><i class="bi bi-heart-pulse me-2"></i>Estado:</strong></p>
                    <p class="ms-4">

                        {% if ficha.estado == 'EN_ALTA' %}
                        <span class="badge bg-success fs-6"><i class="bi bi-check-circle me-1"></i>En Alta</span>

                        {% elif ficha.estado == 'EN_TRATAMIENTO' %}
                        <span class="badge bg-info fs-6"><i class="bi bi-activity me-1"></i>En Tratamiento</span>

                        {% elif ficha.estado == 'PRE_OPERATORIO' %}
                        <span class="badge bg-warning fs-6"><i class="bi bi-clock-history me-1"></i>Preoperatorio</span>

                        {% elif ficha.estado == 'POST_OPERATORIO' %}
                        <span class="badge bg-primary fs-6"><i class="bi bi-bandaid me-1"></i>Postoperatorio</span>

                        {% else %}
                        <span class="badge bg-secondary fs-6">{{ ficha.get_estado_display }}</span>
                        {% endif %}
                    </p>

                    <a href="{% url 'update_patient_status' paciente.pk %}" class="btn btn-warning btn-sm mt-2">
                        <i class="bi bi-pencil-square me-1"></i>Actualizar Estado
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {% if ficha %}
    <!-- Ficha Médica -->
    <div class="card mb-3">
        <div class="card-header bg-info text-white">
            <i class="bi bi-file-medical me-2"></i>Ficha Médica
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <p class="mb-2"><strong><i class="bi bi-clipboard-pulse me-2"></i>Antecedentes Personales:</strong>
                    </p>
                    <p class="ms-4 mb-3">{{ ficha.antecedentes_personales|default:"No registrados" }}</p>

                    <p class="mb-2"><strong><i class="bi bi-people me-2"></i>Antecedentes Familiares:</strong></p>
                    <p class="ms-4 mb-3">{{ ficha.antecedentes_familiares|default:"No registrados" }}</p>
                </div>

                <div class="col-md-6">
                    <p class="mb-2"><strong><i class="bi bi-exclamation-triangle me-2"></i>Alergias:</strong></p>
                    <p class="ms-4 mb-3">{{ ficha.alergias|default:"Ninguna conocida" }}</p>

                    <p class="mb-2"><strong><i class="bi bi-heart me-2"></i>Enfermedades Crónicas:</strong></p>
                    <p class="ms-4 mb-3">{{ ficha.enfermedades_cronicas|default:"Ninguna registrada" }}</p>

                    <p class="mb-2"><strong><i class="bi bi-capsule me-2"></i>Medicamentos Actuales:</strong></p>
                    <p class="ms-4 mb-3">{{ ficha.medicamentos_actuales|default:"Ninguno" }}</p>

                    <a href="{% url 'update_ficha' paciente.pk %}" class="btn btn-primary mt-3">
                        <i class="bi bi-pencil-square me-1"></i>Actualizar Ficha Médica
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Tratamiento Actual -->
    {% if ficha.estado == 'EN_TRATAMIENTO' %}
    {% with atencion_activa=atenciones.first %}
    {% if atencion_activa %}
    <div class="card mb-3 border-info">
        <div class="card-header bg-info text-white">
            <i class="bi bi-clipboard2-pulse me-2"></i>Tratamiento Actual
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <p class="mb-2"><strong><i class="bi bi-chat-left-text me-2"></i>Motivo de Ingreso:</strong></p>
                    <p class="ms-4 mb-3">{{ atencion_activa.motivo_consulta|default:"No especificado" }}</p>

                    <p class="mb-2"><strong><i class="bi bi-building me-2"></i>Área/Sector:</strong></p>
                    <p class="ms-4 mb-3">{{ atencion_activa.area|default:"No asignada" }}</p>

                    <p class="mb-2"><strong><i class="bi bi-calendar-check me-2"></i>Fecha de Ingreso:</strong></p>
                    <p class="ms-4 mb-3">{{ atencion_activa.fecha_entrada|date:"d/m/Y H:i" }}</p>
                </div>

                <div class="col-md-6">
                    <p class="mb-2"><strong><i class="bi bi-person-badge me-2"></i>Médico Responsable:</strong></p>
                    <p class="ms-4 mb-3">
                        {% if atencion_activa.medico_responsable.get_full_name %}
                        {{ atencion_activa.medico_responsable.get_full_name }}
                        {% else %}
                        {{ atencion_activa.medico_responsable.username }}
                        {% endif %}
                    </p>

                    <p class="mb-2"><strong><i class="bi bi-card-text me-2"></i>RUT Médico:</strong></p>
                    <p class="ms-4 mb-3">{{ atencion_activa.medico_responsable.perfil.rut|default:"-" }}</p>

                    <p class="mb-2"><strong><i class="bi bi-clipboard-check me-2"></i>Diagnóstico:</strong></p>
                    <p class="ms-4 mb-3">{{ atencion_activa.diagnostico|default:"Pendiente" }}</p>

                    <p class="mb-2"><strong><i class="bi bi-prescription2 me-2"></i>Tratamiento:</strong></p>
                    <p class="ms-4 mb-3">{{ atencion_activa.tratamiento|default:"Pendiente" }}</p>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    {% endwith %}
    {% endif %}

    <!-- Historial de Atenciones -->
    <div class="card">
        <div class="card-header">
            <i class="bi bi-clock-history me-2"></i>Historial de Atenciones
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Médico</th>
                            <th>RUT</th>
                            <th>Área</th>
                            <th>Diagnóstico</th>
                            <th>Tratamiento</th>
                            <th class="text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for atencion in atenciones %}
                        <tr>
                            <td>{{ atencion.fecha_entrada|date:"d/m/Y H:i" }}</td>

                            <td>
                                {% if atencion.medico_responsable.get_full_name %}
                                {{ atencion.medico_responsable.get_full_name }}
                                {% else %}
                                {{ atencion.medico_responsable.username }}
                                {% endif %}
                            </td>

                            <td>{{ atencion.medico_responsable.perfil.rut|default:"-" }}</td>
                            <td>{{ atencion.area|default:"-" }}</td>
                            <td>{{ atencion.diagnostico|default:"-" }}</td>
                            <td>{{ atencion.tratamiento|default:"-" }}</td>

                            <td class="text-center">
                                <a href="{% url 'update_atencion' atencion.pk %}" class="btn btn-sm btn-primary">
                                    <i class="bi bi-pencil me-1"></i>Actualizar
                                </a>
                            </td>
                        </tr>

                        {% empty %}
                        <tr>
                            <td colspan="7" class="text-center py-4 text-muted">
                                <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                                No hay atenciones registradas
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    {% else %}
    <div class="card">
        <div class="card-body text-center py-5">
            <i class="bi bi-file-medical-fill text-muted" style="font-size: 4rem;"></i>
            <h4 class="mt-3 text-muted">Sin Ficha Médica</h4>
            <p class="text-muted">Este paciente no tiene ficha médica registrada.</p>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}